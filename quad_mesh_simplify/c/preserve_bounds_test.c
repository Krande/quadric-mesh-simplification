#include <stdbool.h>
#include <stdlib.h>
#include "preserve_bounds.h"
#include "utils.h"
#include "test_utils.h"
#include "mesh.h"
#include "sparse_mat.h"

const char* test_case = "preserve bounds";

int main(void) {

  double positions[] = {
    -1., -1., -1.,
		-1., 0., 0.,
		-1., 1., 1.,
		0., 0.25, 0.25,
		0., -0.25, -0.25,
		1., -1., -1.,
		1., 0., 0.,
		1., 1., 1.,
		0., -1., -1.,
		0., 1., 1.
  };

  unsigned int face[] = {
    0, 1, 4,
    1, 3, 4,
    1, 2, 3,
    3, 6, 7,
    3, 4, 6,
    4, 5, 6,
    0, 8, 4,
    5, 4, 8,
    2, 3, 9,
    3, 9, 7
  };

  double q[] = {
    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,

    3., 3., 3., 3.,
    3., 3., 3., 3.,
    3., 3., 3., 3.,
    3., 3., 3., 3.,

    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,

    6., 6., 6., 6.,
    6., 6., 6., 6.,
    6., 6., 6., 6.,
    6., 6., 6., 6.,

    6., 6., 6., 6.,
    6., 6., 6., 6.,
    6., 6., 6., 6.,
    6., 6., 6., 6.,

    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,

    3., 3., 3., 3.,
    3., 3., 3., 3.,
    3., 3., 3., 3.,
    3., 3., 3., 3.,

    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,

    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,

    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.
  };

  double q_old[] = {
    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,

    3., 3., 3., 3.,
    3., 3., 3., 3.,
    3., 3., 3., 3.,
    3., 3., 3., 3.,

    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,

    6., 6., 6., 6.,
    6., 6., 6., 6.,
    6., 6., 6., 6.,
    6., 6., 6., 6.,

    6., 6., 6., 6.,
    6., 6., 6., 6.,
    6., 6., 6., 6.,
    6., 6., 6., 6.,

    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,

    3., 3., 3., 3.,
    3., 3., 3., 3.,
    3., 3., 3., 3.,
    3., 3., 3., 3.,

    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,

    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,

    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.,
    2., 2., 2., 2.
  };

  Mesh m = {positions, NULL, face, 10, 10};

  unsigned int i, j, a, v1, v2;
  SparseMat edges = sparse_empty();

  // create edges
  for (i = 0; i < m.n_face; i++) {
    for (j = 0; j < 3; j++) {
      a = (j + 1) % 3;
      v1 = m.face[i * 3 + j] < m.face[i * 3 + a] ? m.face[i * 3 + j] : m.face[i * 3 + a];
      v2 = m.face[i * 3 + j] == v1 ? m.face[i * 3 + a] : m.face[i * 3 + j];

      // edge was not seen before
      if (sparse_get(&edges, v1, v2) == 0) {
        sparse_set(&edges, v1, v2, 1);
      } else {
        sparse_set(&edges, v1, v2, sparse_get(&edges, v1, v2)+1);
      }
    }
  }

  preserve_bounds(m, q, &edges);

  sparse_free(&edges);

  // 0 - 2 NOT equal
  q_not_equal(test_case, q_old, q, 0, 3 * 16);
  // 3, 4 equal
  q_equal(test_case, q_old, q, 3 * 16, 5 * 16);
  // 5 - 9 NOT equal
  q_not_equal(test_case, q_old, q, 5 * 16, 10 * 16);

  printf("âœ“ %s\n", test_case);
}